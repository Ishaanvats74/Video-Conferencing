<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ConnectNow - Video Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                light: '#8B5CF6',
                DEFAULT: '#7C3AED',
                dark: '#6D28D9',
              },
              secondary: {
                light: '#0EA5E9',
                DEFAULT: '#0284C7',
                dark: '#0369A1',
              },
            }
          }
        }
      }
    </script>
  </head>
  <body class="bg-slate-50 min-h-screen">
    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <!-- App Header -->
      <header class="mb-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="bg-gradient-to-r from-primary to-secondary p-2 rounded-lg">
              <i class="fas fa-video text-white"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800">ConnectNow</h1>
          </div>
          <div class="flex items-center space-x-4">
            <div class="bg-white rounded-full shadow px-4 py-2 flex items-center space-x-2">
              <span class="text-sm font-medium">Your ID:</span>
              <span id="pid" class="text-primary font-semibold"></span>
              <button onclick="copyToClipboard()" class="text-gray-500 hover:text-primary transition">
                <i class="far fa-copy"></i>
              </button>
            </div>
            <div id="connection-badge" class="hidden px-3 py-1 rounded-full text-xs font-medium"></div>
          </div>
        </div>
      </header>

      <!-- Connection Panel -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
          <div class="w-full sm:w-2/3">
            <label for="fid" class="block text-sm font-medium text-gray-700 mb-1">Connect with Friend</label>
            <div class="mt-1 flex rounded-md shadow-sm">
              <input 
                type="text" 
                id="fid" 
                placeholder="Enter your friend's ID" 
                class="flex-1 min-w-0 block w-full px-3 py-2 rounded-l-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
              />
              <button 
                onclick="connect()" 
                class="inline-flex items-center px-4 py-2 border border-transparent rounded-r-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"
              >
                <i class="fas fa-plug mr-2"></i>
                Connect
              </button>
            </div>
          </div>
          <div class="w-full sm:w-1/3">
            <div id="connection-status" class="text-sm text-gray-600 py-2">
              Ready to connect
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="flex flex-col lg:flex-row gap-6">
        <!-- Video Section -->
        <div class="w-full lg:w-2/3 bg-white rounded-xl shadow-md overflow-hidden">
          <div class="p-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-800">
              <i class="fas fa-video mr-2 text-primary"></i>
              Video Call
            </h2>
          </div>
          <div class="p-6">
            <!-- Video Layout -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- My Video -->
              <div class="relative">
                <div class="aspect-video bg-gray-900 rounded-lg overflow-hidden">
                  <video id="myVideo" autoplay muted playsinline class="w-full h-full object-cover"></video>
                </div>
                <div class="absolute bottom-3 left-3 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded-md">
                  You
                </div>
                <div class="absolute bottom-3 right-3 flex space-x-2">
                  <button id="toggle-audio" class="bg-white text-gray-800 p-2 rounded-full shadow hover:bg-gray-100">
                    <i class="fas fa-microphone"></i>
                  </button>
                  <button id="toggle-video" class="bg-white text-gray-800 p-2 rounded-full shadow hover:bg-gray-100">
                    <i class="fas fa-video"></i>
                  </button>
                </div>
              </div>
              
              <!-- Friend Video -->
              <div class="relative">
                <div class="aspect-video bg-gray-900 rounded-lg overflow-hidden flex items-center justify-center" id="friend-video-container">
                  <video id="friendVideo" autoplay playsinline class="w-full h-full object-cover hidden"></video>
                  <div id="waiting-overlay" class="text-center">
                    <div class="text-white text-opacity-80">
                      <i class="fas fa-user-friends text-5xl mb-4"></i>
                      <p>Waiting for friend to join...</p>
                    </div>
                  </div>
                </div>
                <div class="absolute bottom-3 left-3 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded-md">
                  Friend
                </div>
              </div>
            </div>
            
            <!-- Call Controls -->
            <div class="mt-6 flex justify-center">
              <div class="inline-flex shadow-sm rounded-md">
                <button id="end-call" class="px-4 py-2 bg-danger text-white rounded-md hover:bg-red-700 transition">
                  <i class="fas fa-phone-slash mr-2"></i>
                  End Call
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Section -->
        <div class="w-full lg:w-1/3 flex flex-col bg-white rounded-xl shadow-md overflow-hidden">
          <div class="p-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-800">
              <i class="fas fa-comments mr-2 text-primary"></i>
              Chat
            </h2>
          </div>
          
          <!-- Messages -->
          <div id="chat" class="flex-1 p-4 overflow-y-auto h-96 bg-gray-50">
            <div class="flex flex-col space-y-3">
              <div class="text-center text-xs text-gray-500 my-2">
                Messages will appear here
              </div>
            </div>
          </div>
          
          <!-- Message Input -->
          <div class="p-4 border-t border-gray-200">
            <form id="message-form" class="flex space-x-2">
              <input 
                type="text" 
                id="msg" 
                placeholder="Type a message..." 
                class="flex-1 min-w-0 block w-full px-3 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
              />
              <button 
                type="submit"
                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"
              >
                <i class="fas fa-paper-plane mr-2"></i>
                Send
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script>
      // DOM Elements
      const pidElement = document.getElementById("pid");
      const fidInput = document.getElementById("fid");
      const chatBox = document.getElementById("chat");
      const msgInput = document.getElementById("msg");
      const myVideo = document.getElementById("myVideo");
      const friendVideo = document.getElementById("friendVideo");
      const connectionStatus = document.getElementById("connection-status");
      const connectionBadge = document.getElementById("connection-badge");
      const friendVideoContainer = document.getElementById("friend-video-container");
      const waitingOverlay = document.getElementById("waiting-overlay");
      const messageForm = document.getElementById("message-form");
      const toggleAudioBtn = document.getElementById("toggle-audio");
      const toggleVideoBtn = document.getElementById("toggle-video");
      const endCallBtn = document.getElementById("end-call");
      
      // Variables
      let conn;
      let call;
      let localStream;
      let myPeerId = prompt("Enter your desired username") || generateRandomId();
      let audioEnabled = true;
      let videoEnabled = true;
      
      // STUN/TURN configuration
      const iceConfiguration = {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" },
          {
            urls: 'turn:relay1.expressturn.com:3480',
            username: '174697804058590759',
            credential: '7V6VvjOi6CYKrEloCKNhV3t7UB0='
          }
        ],
        iceCandidatePoolSize: 10
      };
      
      // Initialize peer connection
      const peer = new Peer(myPeerId, {
        config: iceConfiguration,
        debug: 3
      });
      
      // Helper functions
      function generateRandomId() {
        return 'user-' + Math.random().toString(36).substr(2, 8);
      }
      
      function updateConnectionStatus(message, type = 'info') {
        connectionStatus.textContent = message;
        
        // Update badge
        connectionBadge.textContent = type === 'connected' ? 'Connected' : 
                                      type === 'disconnected' ? 'Disconnected' : 
                                      type === 'error' ? 'Error' : 'Connecting...';
        
        connectionBadge.className = "px-3 py-1 rounded-full text-xs font-medium inline-block";
        
        if (type === 'connected') {
          connectionBadge.classList.add('bg-green-100', 'text-green-800');
        } else if (type === 'connecting') {
          connectionBadge.classList.add('bg-blue-100', 'text-blue-800');
        } else if (type === 'disconnected') {
          connectionBadge.classList.add('bg-gray-100', 'text-gray-800');
        } else if (type === 'error') {
          connectionBadge.classList.add('bg-red-100', 'text-red-800');
        }
        
        connectionBadge.classList.remove('hidden');
      }
      
      function addMessage(sender, message, isMe = false) {
        const messageClass = isMe ? 
          "self-end bg-primary text-white" : 
          "self-start bg-gray-200 text-gray-800";
        
        const messageEl = document.createElement('div');
        messageEl.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${messageClass}`;
        
        const senderEl = document.createElement('div');
        senderEl.className = `text-xs ${isMe ? 'text-blue-100' : 'text-gray-500'} mb-1`;
        senderEl.textContent = sender;
        
        const textEl = document.createElement('div');
        textEl.textContent = message;
        
        messageEl.appendChild(senderEl);
        messageEl.appendChild(textEl);
        
        const containerEl = document.createElement('div');
        containerEl.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
        containerEl.appendChild(messageEl);
        
        chatBox.appendChild(containerEl);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
      
      function copyToClipboard() {
        navigator.clipboard.writeText(myPeerId).then(() => {
          alert("ID copied to clipboard!");
        });
      }
      
      // Initialize webcam and set up peer listeners
      async function initialize() {
        try {
          // Get local media stream
          localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          myVideo.srcObject = localStream;
          
          // Update UI with peer ID
          pidElement.textContent = myPeerId;
          
          // Set up peer connection event listeners
          setupPeerListeners();
          
          // Add system message
          addSystemMessage("Welcome! Share your ID with a friend to start a video call.");
          
        } catch (err) {
          console.error("Error accessing media devices:", err);
          updateConnectionStatus(`Camera/mic access denied: ${err.message}`, 'error');
        }
      }
      
      function addSystemMessage(message) {
        const systemMsg = document.createElement('div');
        systemMsg.className = "text-center text-xs text-gray-500 my-2";
        systemMsg.textContent = message;
        chatBox.appendChild(systemMsg);
      }
      
      function setupPeerListeners() {
        // Handle incoming data connections
        peer.on("connection", handleIncomingConnection);
        
        // Handle incoming call
        peer.on("call", handleIncomingCall);
        
        // Handle peer connection events
        peer.on("open", id => {
          console.log("Connected to PeerJS server with ID:", id);
          updateConnectionStatus("Ready to connect", 'disconnected');
        });
        
        peer.on("error", err => {
          console.error("PeerJS error:", err);
          updateConnectionStatus(`Connection error: ${err.type}`, 'error');
        });
        
        peer.on("disconnected", () => {
          updateConnectionStatus("Disconnected from server. Attempting to reconnect...", 'disconnected');
          peer.reconnect();
        });
      }
      
      // Handle incoming connection
      function handleIncomingConnection(dataConnection) {
        // Store connection reference
        conn = dataConnection;
        
        // Auto-fill friend ID if empty
        if (!fidInput.value) {
          fidInput.value = conn.peer;
        }
        
        // Connection opened
        conn.on("open", () => {
          updateConnectionStatus(`Connected to ${conn.peer}`, 'connected');
          addSystemMessage(`Connected with ${conn.peer}`);
        });
        
        // Receive messages
        conn.on("data", data => {
          if (typeof data === 'string') {
            addMessage(conn.peer, data);
          } else if (data.type === 'control') {
            handleControlMessage(data);
          }
        });
        
        // Handle connection closing
        conn.on("close", () => {
          updateConnectionStatus("Connection closed", 'disconnected');
          addSystemMessage("Friend disconnected");
        });
      }
      
      function handleControlMessage(data) {
        // Handle control messages (like mute notifications, typing indicators, etc)
        if (data.action === 'audio') {
          const status = data.value ? 'turned on' : 'turned off';
          addSystemMessage(`Friend ${status} their microphone`);
        } else if (data.action === 'video') {
          const status = data.value ? 'turned on' : 'turned off';
          addSystemMessage(`Friend ${status} their camera`);
        }
      }
      
      // Handle incoming call
      function handleIncomingCall(incomingCall) {
        updateConnectionStatus(`Incoming call from ${incomingCall.peer}...`, 'connecting');
        
        // Store call reference
        call = incomingCall;
        
        // Answer the call with our local stream
        call.answer(localStream);
        
        // Listen for stream event
        setupCallEventListeners(call);
        
        // Show friend video container
        waitingOverlay.classList.add('hidden');
        friendVideo.classList.remove('hidden');
      }
      
      function setupCallEventListeners(callObj) {
        // Receive the remote stream
        callObj.on("stream", remoteStream => {
          friendVideo.srcObject = remoteStream;
          updateConnectionStatus(`Connected with ${callObj.peer}`, 'connected');
          
          // Show friend video container
          waitingOverlay.classList.add('hidden');
          friendVideo.classList.remove('hidden');
        });
        
        callObj.on("close", () => {
          // Hide friend video
          friendVideo.classList.add('hidden');
          waitingOverlay.classList.remove('hidden');
          updateConnectionStatus("Call ended", 'disconnected');
        });
        
        callObj.on("error", err => {
          console.error("Call error:", err);
          updateConnectionStatus("Error during call", 'error');
        });
      }
      
      // Connect to a peer
      async function connect() {
        const friendId = fidInput.value.trim();
        
        if (!friendId) {
          updateConnectionStatus("Please enter your friend's ID", 'error');
          return;
        }
        
        updateConnectionStatus(`Connecting to ${friendId}...`, 'connecting');
        
        try {
          // Create data connection
          conn = peer.connect(friendId);
          
          // Wait for connection to open
          conn.on("open", () => {
            updateConnectionStatus(`Connected to ${friendId}`, 'connected');
            addSystemMessage(`Connected with ${friendId}`);
            
            // Set up message handling
            conn.on("data", data => {
              if (typeof data === 'string') {
                addMessage(friendId, data);
              } else if (data.type === 'control') {
                handleControlMessage(data);
              }
            });
            
            // Make video call if we have media access
            if (localStream) {
              call = peer.call(friendId, localStream);
              setupCallEventListeners(call);
            } else {
              updateConnectionStatus("No camera/mic access. Check permissions.", 'error');
            }
          });
          
          conn.on("error", err => {
            console.error("Connection error:", err);
            updateConnectionStatus(`Connection error: ${err}`, 'error');
          });
          
        } catch (err) {
          console.error("Error connecting:", err);
          updateConnectionStatus(`Failed to connect: ${err.message}`, 'error');
        }
      }
      
      // Send a message
      function sendMessage() {
        const message = msgInput.value.trim();
        
        if (!message) return;
        
        if (!conn || !conn.open) {
          updateConnectionStatus("Not connected to anyone. Connect first!", 'error');
          return;
        }
        
        // Send message
        conn.send(message);
        
        // Add to chat
        addMessage("You", message, true);
        
        // Clear input
        msgInput.value = "";
      }
      
      // Media controls
      function toggleAudio() {
        if (localStream) {
          audioEnabled = !audioEnabled;
          localStream.getAudioTracks().forEach(track => {
            track.enabled = audioEnabled;
          });
          
          // Update UI
          toggleAudioBtn.innerHTML = audioEnabled ? 
            '<i class="fas fa-microphone"></i>' : 
            '<i class="fas fa-microphone-slash"></i>';
          
          // Notify peer
          if (conn && conn.open) {
            conn.send({
              type: 'control',
              action: 'audio',
              value: audioEnabled
            });
          }
        }
      }
      
      function toggleVideo() {
        if (localStream) {
          videoEnabled = !videoEnabled;
          localStream.getVideoTracks().forEach(track => {
            track.enabled = videoEnabled;
          });
          
          // Update UI
          toggleVideoBtn.innerHTML = videoEnabled ? 
            '<i class="fas fa-video"></i>' : 
            '<i class="fas fa-video-slash"></i>';
          
          // Notify peer
          if (conn && conn.open) {
            conn.send({
              type: 'control',
              action: 'video',
              value: videoEnabled
            });
          }
        }
      }
      
      function endCall() {
        if (call) {
          call.close();
        }
        
        if (conn) {
          conn.close();
        }
        
        // Reset UI
        friendVideo.classList.add('hidden');
        waitingOverlay.classList.remove('hidden');
        updateConnectionStatus("Call ended", 'disconnected');
        addSystemMessage("Call ended");
      }
      
      // Event listeners
      messageForm.addEventListener("submit", function(event) {
        event.preventDefault();
        sendMessage();
      });
      
      toggleAudioBtn.addEventListener("click", toggleAudio);
      toggleVideoBtn.addEventListener("click", toggleVideo);
      endCallBtn.addEventListener("click", endCall);
      
      // Initialize on page load
      initialize();
      
      // Utility function to generate CSS classes for Tailwind
      function classNames(...classes) {
        return classes.filter(Boolean).join(' ')
      }
    </script>
  </body>
</html>