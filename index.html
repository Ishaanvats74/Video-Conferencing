<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    Your peer ID is: <span id="pid"></span><br />
    Your Friend's peer ID is: <input type="text" name="fid" id="fid" />
    <button onclick="connect()">Connect</button><br />
    <div>
      <h3>Chat</h3>
      <div id="chat"></div>
      <input type="text" name="msg" id="msg" />
      <button onclick="send()">Send</button>
    </div>
    <div>
      <video id="myVideo" autoplay controls></video>
      <video id="friendVideo" autoplay controls></video>
    </div>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script>
      let pid = document.getElementById("pid");
      let chat = document.getElementById("chat");
      let myVideo = document.getElementById("myVideo");
      let friendVideo = document.getElementById("friendVideo");
      let getUserMedia = navigator.getUserMedia;
      let myPeerId = window.prompt("Enter your peer ID");
      
      var conn;
      var peer = new Peer(myPeerId);

      pid.innerText = myPeerId;

      function connect() {
        let fid = document.getElementById("fid").value;
        conn = peer.connect(fid);
        conn.on("open", function () {
          conn.send("Connected!!!");
        });
        getUserMedia({ video: true, audio: true }, function (stream) {
          var call = peer.call(fid, stream);
          myVideo.srcObject = stream;
          call.on("stream", function (remoteStream) {
            friendVideo.srcObject = remoteStream;
          });
        });
      }

      function send() {
        let msg = document.getElementById("msg").value;
        chat.innerHTML += "<p>" + `${myPeerId}: ` + msg + "</p>";
        conn.send(msg);
      }

      peer.on("connection", function (conn) {
        let fid = document.getElementById("fid").value;
        conn.on("data", function (data) {
          if (document.getElementById("fid").value === "") {
            document.getElementById("fid").value = conn.peer;
            connect();
          }
          chat.innerHTML += "<p>" + `${document.getElementById("fid").value}: ` + data + "</p>";
        });
      });

      peer.on("call", function (call) {
        getUserMedia({video: true, audio: true }, function (stream) {
          call.answer(stream);
          myVideo.srcObject = stream;
          call.on("stream", function(remoteStream) {
            friendVideo.srcObject = remoteStream;
          });
        });
      });
    </script>
  </body>
</html>
